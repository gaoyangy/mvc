<!DOCTYPE html>
<meta charset="utf-8" />
<title>im</title>
<script src="./lib/socket.io.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="./css/style.css">
<script src="./utils/jquery-3.2.1.min.js" type="text/javascript"></script>
<style>

</style>

<body>
    <h3 style="text-align:center">聊天室</h3>
    <div id="show"></div>
    <div class="comment">
        <div class="com_form">
            <span class="emotion">表情</span>
            <textarea class="input" id="saytext" name="saytext" cols="70" rows="5"></textarea>
            <p>
                <input type="button" class="sub_btn" value="发送">
            </p>
        </div>
    </div>
</body>
<script src="./utils/face.js" type="text/javascript"></script>
<script>
    $(function() {
        //var socket = io.connect('http://192.168.100.137:8080'); //与服务器进行连接192.168.2.102
        var socket = io.connect('http://192.168.2.102:8080'); //与服务器进行连接192.168.2.102
        let userInfo = JSON.parse(localStorage.getItem('userInfo'));
        userInfo.firstLogin = true;
        $('.emotion').qqFace({
            id: 'facebox',
            assign: 'saytext',
            path: './images/gif/' //表情存放的路径
        });
        socket.on('connect', function() {
            socket.send(userInfo);
            // button.onclick = function() {
            //     let userInfo = JSON.parse(localStorage.getItem('userInfo'));
            //     userInfo.message = inputData.value
            //     socket.emit('foo', userInfo); //发送一个名为foo的事件，并且传递一个字符串数据‘hello’
            // }
            $(".sub_btn").click(function() {
                var str = $("#saytext").val();
                userInfo.message = replace_em(str)
                socket.emit('foo', userInfo);
                $("#saytext").val("")
                    //$("#show").html(replace_em(str));
            });
            socket.on('historyMsg', data => {
                console.log(data)
                userInfo.firstLogin = false
                data.forEach(function(element) {
                    var msglist = document.createElement("p");
                    msglist.innerHTML = element.user_name + '：' + element.msg
                    $("#show").append(msglist)
                }, this);
            })
            socket.on('msg', function(data) {
                var msglist = document.createElement("p");
                msglist.innerHTML = data.userInfo.user_name + '：' + data.userInfo.message
                $("#show").append(msglist)
            }); //logout
            socket.on('logout', function(data) {
                socket.emit('logout_time', userInfo);
            })
        })
    });

    //字符串转表情
    function replace_em(str) {
        str = str.replace(/\</g, '&lt;');
        str = str.replace(/\>/g, '&gt;');
        str = str.replace(/\n/g, '<br/>');
        str = str.replace(/\[em_([0-9]*)\]/g, '<img src="./images/gif/$1.gif" border="0" />');
        return str;
    }
</script>

</html>